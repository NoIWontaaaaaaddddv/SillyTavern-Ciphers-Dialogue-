import"../../../../script.js";import"../translate/index.js";class e{constructor(e=/\s"(.*?)"/dg){this.regex=e}extract(e){let a,t=[];for(this.regex.lastIndex=0;null!==(a=this.regex.exec(e));){let e=Array.from(a.indices[1]);console.log("Our indices array: "),console.log(e),t.push({text:a[1],bounds:{start:e[0],end:e[1]}})}return t}}const a=e=>new Promise(a=>setTimeout(a,e));class t{constructor(e="ja"){this.language=e,this.type="translate",this.translationArr=[]}async translateArrayOfSentences(e,t="en"){let s=[];for(let n of e){try{let e=await translate(n,t);console.log(`Translated: ${n} -> ${e}`),s.push({original:n,translated:e})}catch(e){console.error(e),s.push({original:n,translated:null})}await a(250)}return s}async translateSentence(e,a){let t=[e];return(await this.translateArrayOfSentences(t,a))[0].translated}}class s{constructor(){this.localStorageKey="SillyTavernLanguageAndCipher",this.characterLanguageData=localStorage.getItem(this.localStorageKey)?JSON.parse(localStorage.getItem(this.localStorageKey)):{},console.log("Initialized to:"),console.log(this.characterLanguageData)}getCharacterLanguageData(e){return this.characterLanguageData[e]||(this.setCharacterLanguageData(e,"en"),this.saveCharactersLanguageData()),this.characterLanguageData[e].lang}setCharacterLanguageData(e,a="en"){this.characterLanguageData[e]||(this.characterLanguageData[e]={}),this.characterLanguageData[e].lang=a,this.saveCharactersLanguageData()}saveCharactersLanguageData(){localStorage.setItem(this.localStorageKey,JSON.stringify(this.characterLanguageData))}}const n={Afrikaans:"af",Albanian:"sq",Amharic:"am",Arabic:"ar",Armenian:"hy",Azerbaijani:"az",Basque:"eu",Belarusian:"be",Bengali:"bn",Bosnian:"bs",Bulgarian:"bg",Catalan:"ca",Cebuano:"ceb","Chinese (Simplified)":"zh-CN","Chinese (Traditional)":"zh-TW",Corsican:"co",Croatian:"hr",Czech:"cs",Danish:"da",Dutch:"nl",English:"en",Esperanto:"eo",Estonian:"et",Finnish:"fi",French:"fr",Frisian:"fy",Galician:"gl",Georgian:"ka",German:"de",Greek:"el",Gujarati:"gu","Haitian Creole":"ht",Hausa:"ha",Hawaiian:"haw",Hebrew:"iw",Hindi:"hi",Hmong:"hmn",Hungarian:"hu",Icelandic:"is",Igbo:"ig",Indonesian:"id",Irish:"ga",Italian:"it",Japanese:"ja",Javanese:"jw",Kannada:"kn",Kazakh:"kk",Khmer:"km",Korean:"ko",Kurdish:"ku",Kyrgyz:"ky",Lao:"lo",Latin:"la",Latvian:"lv",Lithuanian:"lt",Luxembourgish:"lb",Macedonian:"mk",Malagasy:"mg",Malay:"ms",Malayalam:"ml",Maltese:"mt",Maori:"mi",Marathi:"mr",Mongolian:"mn","Myanmar (Burmese)":"my",Nepali:"ne",Norwegian:"no","Nyanja (Chichewa)":"ny",Pashto:"ps",Persian:"fa",Polish:"pl","Portuguese (Portugal)":"pt-PT","Portuguese (Brazil)":"pt-BR",Punjabi:"pa",Romanian:"ro",Russian:"ru",Samoan:"sm","Scots Gaelic":"gd",Serbian:"sr",Sesotho:"st",Shona:"sn",Sindhi:"sd","Sinhala (Sinhalese)":"si",Slovak:"sk",Slovenian:"sl",Somali:"so",Spanish:"es",Sundanese:"su",Swahili:"sw",Swedish:"sv","Tagalog (Filipino)":"tl",Tajik:"tg",Tamil:"ta",Telugu:"te",Thai:"th",Turkish:"tr",Ukrainian:"uk",Urdu:"ur",Uzbek:"uz",Vietnamese:"vi",Welsh:"cy",Xhosa:"xh",Yiddish:"yi",Yoruba:"yo",Zulu:"zu"};class r{constructor(e){this.chatInterface=e}updateMessage(e,a){if(!this.chatInterface.updateMessage)throw new Error("updateMessage in chatManipulator class must be implemented!");this.chatInterface.updateMessage(e,a)}getChat(){if(!this.chatInterface.getChat)throw new Error("getChat in chatManipulator class must be implemented!");return this.chatInterface.getChat()}getMessageData(e){return this.getChat()[e]}getMessageContent(e){return this.getChat()[e].mes}matchingMessages(e){const a=this.getChat();console.log("current chat?"),console.log(a);let t={};for(let s=0;s<a.length;s++)e(a[s])&&(t[s]=a[s]);return t}getUserMessages(){return this.matchingMessages(e=>{e.is_user})}getMessagesByCharName(e){return this.matchingMessages(e=>{e.name})}getCharacterMessages(){return this.matchingMessages(e=>(console.log("Curr mesData:"),console.log(e),!e.is_user&&!e.is_system))}}console.log("Webpack plugin initialized!");let i=SillyTavern.getContext(),l=i.eventTypes,o=i.eventSource,g=!1;const c={translationService:!1},h="SillyTavernLanguageAndCiphers";let u=new class{constructor(a,n){this.translator=a||new t,this.parser=n||new e,this.customLanguage=!1;let i=SillyTavern.getContext;this.characterManager=new s,this.isDisabled=!0;let g={getChat:()=>i().chat,updateMessage:(e,a)=>i().updateMessageBlock(e,{mes:a}),deleteMessage:e=>i().deleteMessage,deleteLastMessage:()=>i().deleteLastMessage};this.manipulator=new r(g),this.extracted_text={},this.originalMessages={},this.rule=/"(.*?)"/dg,o.on(l.MESSAGE_DELETED,e=>{for(let a in this.extracted_text)parseInt(a)>=e&&(delete this.extracted_text[a],delete this.originalMessages[a],console.log("Deleted message id "+a))})}setDisabled(e){this.isDisabled=e,e?(console.log("Extension Disabled: Reverting text..."),this.revertAllMessages()):(console.log("Extension Enabled: Translating chat..."),this.translateChat())}async revertAllMessages(){for(let e in this.extracted_text)this.originalMessages[e]&&(this.manipulator.updateMessage(parseInt(e),this.originalMessages[e]),delete this.extracted_text[e])}getTranslationMessageData(e){return this.extracted_text[e]}async update_messages(){let e={};if(this.isDisabled||null!==SillyTavern.getContext().groupId)return;let a=this.manipulator.getCharacterMessages();console.log("Returned character messages: "),console.log(a);for(let t in a){let s=a[t];if(void 0===this.extracted_text[t])try{let a=this.manipulator.getMessageData(parseInt(t)).name,n=this.characterManager.getCharacterLanguageData(a),r=await this.translateTextBasedOnParser(s.mes,n);this.extracted_text[t]=r.messageData,console.log("What are original messages so far?"),console.log(this.originalMessages),this.originalMessages[t]=s.mes,console.log("Updated:"),console.log(this.originalMessages[t]),e[t]=r.translatedMessage}catch(e){console.error(`Translation failed for Msg ID ${t}:`,e)}}return e}async translateChat(){console.log("Translating chat..."),this.update_messages().then(e=>{for(let a in e)console.log("translated contents: "),console.log(e),this.manipulator.updateMessage(parseInt(a),e[a])},e=>{console.error("Error asking to translate chat:",e)})}async translateTextBasedOnParser(e,a){if(this.customLanguage)return;let t=this.parser.extract(e),s=e,n=[];for(let e of t){let t={originalStr:e.text,bounds:e.bounds,translatedStr:await this.translator.translateSentence(e.text,a)};n.push(t)}n.sort((e,a)=>a.bounds.start-e.bounds.start);for(let e of n){let a=e.bounds.start,t=e.bounds.end;s=s.slice(0,a)+e.translatedStr+s.slice(t)}return{messageData:n,translatedMessage:s}}clearEverything(){this.extracted_text={},this.originalMessages={}}async translateMessageAndUpdate(e){let a=this.manipulator.getMessageData(e).mes,t=this.characterManager.getCharacterLanguageData(this.manipulator.getMessageData(e).name);this.translateTextBasedOnParser(a,t).then(a=>{console.log("What is translated message data?"),console.log(a),this.extracted_text[e]=a.messageData,this.manipulator.updateMessage(e,a.translatedMessage)})}updateCharacterLanguage(e,a){this.characterManager.setCharacterLanguageData(e,a)}returnCharacterLanguage(e){return this.characterManager.getCharacterLanguageData(e)}};o.on(l.GENERATE_AFTER_DATA,(e,a)=>{console.log("Completion settings:"),console.log(e);let t=i.chatCompletionSettings.new_chat_prompt,s=0;if(g){console.log("Generation started!!");for(let a=0;a<e.prompt.length;a++){let n=a-s;e.prompt[a].content==t&&(s=a+1),null!==s&&u.extracted_text[n]&&(e.prompt[a].content=u.originalMessages[n])}}console.log("Modified prompt:"),console.log(e.prompt)}),o.on(l.MESSAGE_SENT,()=>{g=!0}),o.on(l.CHAT_CREATED,()=>{u.extracted_text={},u.originalMessages={},u.translateChat()}),o.on(l.CHAT_CHANGED,()=>{!async function(){const e=document.getElementById("cipher-extension-drawer");e&&e.remove();let a=$("#avatar-and-name-block"),t=SillyTavern.getContext().characterId;if(void 0===t)return;let s=SillyTavern.getContext().characters[t].name,r=document.createElement("div");r.id="cipher-extension-drawer",r.classList.add("inline-drawer"),r.style.marginTop="5px",r.style.borderTop="1px solid #444",r.style.paddingTop="5px";let i=document.createElement("select");i.id="character-language-select",i.classList.add("text_pole"),i.style.width="60%",i.style.marginRight="5px";for(let e in n){let a=document.createElement("option");a.value=n[e],a.textContent=e,i.append(a)}let l=document.createElement("label");l.classList.add("checkbox_label"),l.innerHTML="Cipher: ";let o=document.createElement("input");o.type="checkbox",o.checked=!u.isDisabled,o.addEventListener("change",()=>{u.setDisabled(!o.checked)}),l.append(o),r.append(i),r.append(l),a.after(r);let g=u.returnCharacterLanguage(s);for(let e in n)n[e]==g&&(i.value=n[e]);u.updateCharacterLanguage(s,g||i.value),i.addEventListener("change",()=>{u.updateCharacterLanguage(s,i.value),u.revertAllMessages(),u.extracted_text={},u.translateChat()}),console.log("Mounted options!")}(),u.translateChat()}),o.on(l.MESSAGE_RECEIVED,()=>{u.translateMessageAndUpdate(SillyTavern.getContext().chat.length-1),g=!1}),jQuery(async()=>{SillyTavern.getContext().renderExtensionTemplateAsync("translation-and-ciphers","settings"),async function(){let e=SillyTavern.getContext().extensionSettings;0===Object.keys(e[h]).length&&(e[h]=c)}()});
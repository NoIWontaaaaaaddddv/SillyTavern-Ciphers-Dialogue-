import"../../../../script.js";class e{constructor(e=/"(.*?)"/dg){this.regex=e}extract(e){let t,a=[];for(this.regex.lastIndex=0;null!==(t=this.regex.exec(e));){let e=Array.from(t.indices[1]);console.log("Our indices array: "),console.log(e),a.push({text:t[1],bounds:{start:e[0],end:e[1]}})}return a}}const t=e=>new Promise(t=>setTimeout(t,e));let a=function(e,t){return console.log("Translating using import replacement..."),SillyTavern.getContext().executeSlashCommandsWithOptions(`/translate target=${t} ${e}`)};class s{constructor(e="ja"){this.language=e,this.type="translate",this.translationArr=[]}async translateArrayOfSentences(e,s="en"){let n=[];for(let r of e){try{let e=(await a(r,s)).pipe;console.log(`Translated: ${r} -> ${e}`),n.push({original:r,translated:e})}catch(e){console.error(e),n.push({original:r,translated:null})}await t(250)}return n}async translateSentence(e,t){let a=[e];return(await this.translateArrayOfSentences(a,t))[0].translated}}class n{constructor(e,t){this.localStorageKey="CharacterLanguages";try{this.extensionSettings=e,this.extensionSettings[this.localStorageKey]||(this.extensionSettings[this.localStorageKey]={}),console.log("Initialized to:"),console.log(this.extensionSettings),this.saveFunc=t}catch(e){throw new Error("Failed to initialize character manager's settings!")}}getCharacterLanguageData(e){return console.log("Settings:"),console.log(this.extensionSettings),this.extensionSettings[this.localStorageKey][e]||"en"}setCharacterLanguageData(e,t="en"){this.extensionSettings[this.localStorageKey][e]=t,this.saveCharactersLanguageData()}saveCharactersLanguageData(){this.saveFunc().then(function(e){console.log("Managed to save settings successfully!"),console.log(e)},function(e){console.error("An error has occured while saving settings in CharacterManagerServiceAdapter"),console.error(e)})}}const r={Afrikaans:"af",Albanian:"sq",Amharic:"am",Arabic:"ar",Armenian:"hy",Azerbaijani:"az",Basque:"eu",Belarusian:"be",Bengali:"bn",Bosnian:"bs",Bulgarian:"bg",Catalan:"ca",Cebuano:"ceb","Chinese (Simplified)":"zh-CN","Chinese (Traditional)":"zh-TW",Corsican:"co",Croatian:"hr",Czech:"cs",Danish:"da",Dutch:"nl",English:"en",Esperanto:"eo",Estonian:"et",Finnish:"fi",French:"fr",Frisian:"fy",Galician:"gl",Georgian:"ka",German:"de",Greek:"el",Gujarati:"gu","Haitian Creole":"ht",Hausa:"ha",Hawaiian:"haw",Hebrew:"iw",Hindi:"hi",Hmong:"hmn",Hungarian:"hu",Icelandic:"is",Igbo:"ig",Indonesian:"id",Irish:"ga",Italian:"it",Japanese:"ja",Javanese:"jw",Kannada:"kn",Kazakh:"kk",Khmer:"km",Korean:"ko",Kurdish:"ku",Kyrgyz:"ky",Lao:"lo",Latin:"la",Latvian:"lv",Lithuanian:"lt",Luxembourgish:"lb",Macedonian:"mk",Malagasy:"mg",Malay:"ms",Malayalam:"ml",Maltese:"mt",Maori:"mi",Marathi:"mr",Mongolian:"mn","Myanmar (Burmese)":"my",Nepali:"ne",Norwegian:"no","Nyanja (Chichewa)":"ny",Pashto:"ps",Persian:"fa",Polish:"pl","Portuguese (Portugal)":"pt-PT","Portuguese (Brazil)":"pt-BR",Punjabi:"pa",Romanian:"ro",Russian:"ru",Samoan:"sm","Scots Gaelic":"gd",Serbian:"sr",Sesotho:"st",Shona:"sn",Sindhi:"sd","Sinhala (Sinhalese)":"si",Slovak:"sk",Slovenian:"sl",Somali:"so",Spanish:"es",Sundanese:"su",Swahili:"sw",Swedish:"sv","Tagalog (Filipino)":"tl",Tajik:"tg",Tamil:"ta",Telugu:"te",Thai:"th",Turkish:"tr",Ukrainian:"uk",Urdu:"ur",Uzbek:"uz",Vietnamese:"vi",Welsh:"cy",Xhosa:"xh",Yiddish:"yi",Yoruba:"yo",Zulu:"zu"};class i{constructor(e){this.chatInterface=e}updateMessage(e,t){if(!this.chatInterface.updateMessage)throw new Error("updateMessage in chatManipulator class must be implemented!");this.chatInterface.updateMessage(e,t)}getChat(){if(!this.chatInterface.getChat)throw new Error("getChat in chatManipulator class must be implemented!");return this.chatInterface.getChat()}getMessageData(e){return this.getChat()[e]}getMessageContent(e){return this.getChat()[e].mes}matchingMessages(e){const t=this.getChat();console.log("current chat?"),console.log(t);let a={};for(let s=0;s<t.length;s++)e(t[s])&&(a[s]=t[s]);return a}getUserMessages(){return this.matchingMessages(e=>{e.is_user})}getMessagesByCharName(e){return this.matchingMessages(e=>{e.name})}getCharacterMessages(){return this.matchingMessages(e=>(console.log("Curr mesData:"),console.log(e),!e.is_user&&!e.is_system))}}console.log("Webpack plugin initialized!");let l=SillyTavern.getContext(),o=l.eventTypes,g=l.eventSource,h=!1,c=new class{constructor(e){this.settingsObject={},this.managerInterface=e,this.extensionName="SillyTavernLanguageAndCiphers"}async getSettings(){if(!this.managerInterface.getSettings)throw new Error("Settings manager must have getSettings method!");try{let e=await this.managerInterface.getSettings();return e[this.extensionName]||(e[this.extensionName]={}),e[this.extensionName]}catch(e){throw console.error(e),new Error("An error occured while trying to save settings in SettingsManager instance")}}async saveSettings(){if(!this.managerInterface.saveSettings)throw new Error("Settings manager must have saveSettings method!");try{await this.managerInterface.saveSettings(this.settingsObject)}catch(e){throw console.error(e),new Error("An error occured while trying to save settings in SettingsManager instance")}}}({getSettings:()=>SillyTavern.getContext().extensionSettings,saveSettings:SillyTavern.getContext().saveSettingsDebounced}),u=new class{constructor(t,a){this.translator=t||new s,this.parser=a||new e,this.customLanguage=!1;let r=SillyTavern.getContext;try{c.getSettings().then(e=>{this.characterManager=new n(e,()=>c.saveSettings())}),this.isDisabled=!0;let e={getChat:()=>r().chat,updateMessage:(e,t)=>r().updateMessageBlock(e,{mes:t}),deleteMessage:e=>r().deleteMessage,deleteLastMessage:()=>r().deleteLastMessage};this.manipulator=new i(e),this.translatedMessages={},this.originalMessages={},this.rule=/"(.*?)"/dg,g.on(o.MESSAGE_DELETED,e=>{for(let t in this.originalMessages)parseInt(t)>=e&&delete this.originalMessages[t];for(let t in this.translatedMessages)parseInt(t)>=e&&delete this.translatedMessages[t];this.isDisabled||this.translateChat()})}catch(e){throw console.error(e),new Error("An error occured while trying to initialize primary translatorController instance")}}setDisabled(e){this.isDisabled=e,e?(console.log("Extension Disabled: Reverting text..."),this.revertAllMessages()):(console.log("Extension Enabled: Translating chat..."),this.translateChat())}async revertAllMessages(){for(let e in this.translatedMessages)this.originalMessages[e]&&this.manipulator.updateMessage(parseInt(e),this.originalMessages[e].mes)}async update_messages(){let e={},t=this.manipulator.getCharacterMessages();for(let a in t){let s=t[a];void 0===this.originalMessages[a]&&(this.originalMessages[a]=s),this.translatedMessages[a]?this.manipulator.updateMessage(parseInt(a),this.translatedMessages[a].mes):e[a]=s}return e}async translateChat(){if(console.log("translateChat() fired",{disabled:this.isDisabled,chatLen:this.manipulator.getChat().length,originalKeys:Object.keys(this.originalMessages),translatedKeys:Object.keys(this.translatedMessages)}),this.isDisabled)return;console.log("Translating chat...");let e=await this.update_messages();try{for(let t in e){let a=e[t].mes,s=e[t].name,n=this.characterManager.getCharacterLanguageData(s),r=await this.translateTextBasedOnParser(a,n),i=structuredClone(this.originalMessages[t]);i.mes=r.translatedMessage,this.translatedMessages[t]=i,this.manipulator.updateMessage(parseInt(t),i.mes)}}catch(e){console.error("A severe error occured while attempting to translate the chat."),console.error(e)}}async translateTextBasedOnParser(e,t){if(this.isDisabled)return;if(this.customLanguage)return;let a=this.parser.extract(e),s=e,n={},r=[];for(let e of a)n={originalStr:e.text,bounds:e.bounds,translatedStr:await this.translator.translateSentence(e.text,t)},r.push(n);r.sort((e,t)=>t.bounds.start-e.bounds.start);for(let e of r){let t=e.bounds.start,a=e.bounds.end;s=s.slice(0,t)+e.translatedStr+s.slice(a)}return{messageData:r,translatedMessage:s}}clearEverything(){this.translatedMessages={},this.originalMessages={}}async translateMessageAndUpdate(e){if(this.isDisabled)return;let t=this.manipulator.getMessageData(e).mes,a=this.characterManager.getCharacterLanguageData(this.manipulator.getMessageData(e).name);this.translateTextBasedOnParser(t,a).then(t=>{this.translatedMessages[e]=t.messageData,this.manipulator.updateMessage(e,t.translatedMessage)})}updateCharacterLanguage(e,t){this.characterManager.setCharacterLanguageData(e,t)}returnCharacterLanguage(e){return this.characterManager.getCharacterLanguageData(e)}};g.on(o.MESSAGE_SENT,()=>{h=!0}),g.on(o.CHAT_CREATED,()=>{u.clearEverything(),u.translateChat()}),g.on(o.CHAT_CHANGED,()=>{!async function(){const e=document.getElementById("cipher-extension-drawer");e&&e.remove();let t=$("#avatar-and-name-block"),a=SillyTavern.getContext().characterId;if(void 0===a)return;let s=SillyTavern.getContext().characters[a].name,n=document.createElement("div");n.id="cipher-extension-drawer",n.classList.add("inline-drawer"),n.style.marginTop="5px",n.style.borderTop="1px solid #444",n.style.paddingTop="5px";let i=document.createElement("select");i.id="character-language-select",i.classList.add("text_pole"),i.style.width="60%",i.style.marginRight="5px";for(let e in r){let t=document.createElement("option");t.value=r[e],t.textContent=e,i.append(t)}let l=document.createElement("label");l.classList.add("checkbox_label"),l.innerHTML="Cipher: ";let o=document.createElement("input");o.type="checkbox",o.checked=!u.isDisabled,o.addEventListener("change",()=>{u.setDisabled(!o.checked)}),l.append(o),n.append(i),n.append(l),t.after(n);let g=u.returnCharacterLanguage(s);for(let e in r)r[e]==g&&(i.value=r[e]);u.updateCharacterLanguage(s,g||i.value),i.addEventListener("change",()=>{u.updateCharacterLanguage(s,i.value),u.revertAllMessages(),u.clearEverything(),u.translateChat()}),console.log("Mounted options!")}(),u.clearEverything(),u.update_messages(),u.translateChat(),console.log("Our current settings:"),c.getSettings().then(function(e){console.log(e)})}),g.on(o.MESSAGE_RECEIVED,()=>{u.translateChat()}),globalThis.reverseTranslation=async function(e){for(let t=0;t<e.length;t++){let a=structuredClone(e[t]);if(console.log("Our original messages at this stage:"),void 0!==u.originalMessages[t])try{a.mes=u.originalMessages[t].mes}catch(e){console.error("Encountered error while trying to reverse translation. Falling back to current message at "+t),console.error(e),a.mes=a.mes}e[t]=a,console.log(e[t])}};
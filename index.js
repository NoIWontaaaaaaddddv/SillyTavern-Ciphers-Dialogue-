import"../../../../script.js";import"../../translate/index.js";class e{constructor(e=/\s"(.*?)"/dg){this.regex=e}extract(e){let a,t=[];for(this.regex.lastIndex=0;null!==(a=this.regex.exec(e));){let e=Array.from(a.indices[1]);console.log("Our indices array: "),console.log(e),t.push({text:a[1],bounds:{start:e[0],end:e[1]}})}return t}}const a=e=>new Promise(a=>setTimeout(a,e));let t=function(e,a){return console.log("Translating using import replacement..."),SillyTavern.getContext().executeSlashCommandsWithOptions(`/translate target=${a} ${e}`)};class s{constructor(e="ja"){this.language=e,this.type="translate",this.translationArr=[]}async translateArrayOfSentences(e,s="en"){let n=[];for(let r of e){try{let e=(await t(r,s)).pipe;console.log(`Translated: ${r} -> ${e}`),n.push({original:r,translated:e})}catch(e){console.error(e),n.push({original:r,translated:null})}await a(250)}return n}async translateSentence(e,a){let t=[e];return(await this.translateArrayOfSentences(t,a))[0].translated}}class n{constructor(){this.localStorageKey="SillyTavernLanguageAndCipher",this.characterLanguageData=localStorage.getItem(this.localStorageKey)?JSON.parse(localStorage.getItem(this.localStorageKey)):{},console.log("Initialized to:"),console.log(this.characterLanguageData)}getCharacterLanguageData(e){return this.characterLanguageData[e]||(this.setCharacterLanguageData(e,"en"),this.saveCharactersLanguageData()),this.characterLanguageData[e].lang}setCharacterLanguageData(e,a="en"){this.characterLanguageData[e]||(this.characterLanguageData[e]={}),this.characterLanguageData[e].lang=a,this.saveCharactersLanguageData()}saveCharactersLanguageData(){localStorage.setItem(this.localStorageKey,JSON.stringify(this.characterLanguageData))}}const r={Afrikaans:"af",Albanian:"sq",Amharic:"am",Arabic:"ar",Armenian:"hy",Azerbaijani:"az",Basque:"eu",Belarusian:"be",Bengali:"bn",Bosnian:"bs",Bulgarian:"bg",Catalan:"ca",Cebuano:"ceb","Chinese (Simplified)":"zh-CN","Chinese (Traditional)":"zh-TW",Corsican:"co",Croatian:"hr",Czech:"cs",Danish:"da",Dutch:"nl",English:"en",Esperanto:"eo",Estonian:"et",Finnish:"fi",French:"fr",Frisian:"fy",Galician:"gl",Georgian:"ka",German:"de",Greek:"el",Gujarati:"gu","Haitian Creole":"ht",Hausa:"ha",Hawaiian:"haw",Hebrew:"iw",Hindi:"hi",Hmong:"hmn",Hungarian:"hu",Icelandic:"is",Igbo:"ig",Indonesian:"id",Irish:"ga",Italian:"it",Japanese:"ja",Javanese:"jw",Kannada:"kn",Kazakh:"kk",Khmer:"km",Korean:"ko",Kurdish:"ku",Kyrgyz:"ky",Lao:"lo",Latin:"la",Latvian:"lv",Lithuanian:"lt",Luxembourgish:"lb",Macedonian:"mk",Malagasy:"mg",Malay:"ms",Malayalam:"ml",Maltese:"mt",Maori:"mi",Marathi:"mr",Mongolian:"mn","Myanmar (Burmese)":"my",Nepali:"ne",Norwegian:"no","Nyanja (Chichewa)":"ny",Pashto:"ps",Persian:"fa",Polish:"pl","Portuguese (Portugal)":"pt-PT","Portuguese (Brazil)":"pt-BR",Punjabi:"pa",Romanian:"ro",Russian:"ru",Samoan:"sm","Scots Gaelic":"gd",Serbian:"sr",Sesotho:"st",Shona:"sn",Sindhi:"sd","Sinhala (Sinhalese)":"si",Slovak:"sk",Slovenian:"sl",Somali:"so",Spanish:"es",Sundanese:"su",Swahili:"sw",Swedish:"sv","Tagalog (Filipino)":"tl",Tajik:"tg",Tamil:"ta",Telugu:"te",Thai:"th",Turkish:"tr",Ukrainian:"uk",Urdu:"ur",Uzbek:"uz",Vietnamese:"vi",Welsh:"cy",Xhosa:"xh",Yiddish:"yi",Yoruba:"yo",Zulu:"zu"};class i{constructor(e){this.chatInterface=e}updateMessage(e,a){if(!this.chatInterface.updateMessage)throw new Error("updateMessage in chatManipulator class must be implemented!");this.chatInterface.updateMessage(e,a)}getChat(){if(!this.chatInterface.getChat)throw new Error("getChat in chatManipulator class must be implemented!");return this.chatInterface.getChat()}getMessageData(e){return this.getChat()[e]}getMessageContent(e){return this.getChat()[e].mes}matchingMessages(e){const a=this.getChat();console.log("current chat?"),console.log(a);let t={};for(let s=0;s<a.length;s++)e(a[s])&&(t[s]=a[s]);return t}getUserMessages(){return this.matchingMessages(e=>{e.is_user})}getMessagesByCharName(e){return this.matchingMessages(e=>{e.name})}getCharacterMessages(){return this.matchingMessages(e=>(console.log("Curr mesData:"),console.log(e),!e.is_user&&!e.is_system))}}console.log("Webpack plugin initialized!");let l=SillyTavern.getContext(),o=l.eventTypes,g=l.eventSource,c=!1;const h={translationService:!1},u="SillyTavernLanguageAndCiphers";let d=new class{constructor(a,t){this.translator=a||new s,this.parser=t||new e,this.customLanguage=!1;let r=SillyTavern.getContext;this.characterManager=new n,this.isDisabled=!0;let l={getChat:()=>r().chat,updateMessage:(e,a)=>r().updateMessageBlock(e,{mes:a}),deleteMessage:e=>r().deleteMessage,deleteLastMessage:()=>r().deleteLastMessage};this.manipulator=new i(l),this.extracted_text={},this.originalMessages={},this.rule=/"(.*?)"/dg,g.on(o.MESSAGE_DELETED,e=>{for(let a in this.extracted_text)parseInt(a)>=e&&(delete this.extracted_text[a],delete this.originalMessages[a],console.log("Deleted message id "+a))})}setDisabled(e){this.isDisabled=e,e?(console.log("Extension Disabled: Reverting text..."),this.revertAllMessages()):(console.log("Extension Enabled: Translating chat..."),this.translateChat())}async revertAllMessages(){for(let e in this.extracted_text)this.originalMessages[e]&&(this.manipulator.updateMessage(parseInt(e),this.originalMessages[e]),delete this.extracted_text[e])}getTranslationMessageData(e){return this.extracted_text[e]}async update_messages(){let e={};if(this.isDisabled||null!==SillyTavern.getContext().groupId)return;let a=this.manipulator.getCharacterMessages();console.log("Returned character messages: "),console.log(a);for(let t in a){let s=a[t];if(void 0===this.extracted_text[t])try{let a=this.manipulator.getMessageData(parseInt(t)).name,n=this.characterManager.getCharacterLanguageData(a),r=await this.translateTextBasedOnParser(s.mes,n);this.extracted_text[t]=r.messageData,this.originalMessages[t]=s.mes,e[t]=r.translatedMessage}catch(e){console.error(`Translation failed for Msg ID ${t}:`,e)}}return e}async translateChat(){console.log("Translating chat..."),this.update_messages().then(e=>{for(let a in e)console.log("translated contents: "),console.log(e),this.manipulator.updateMessage(parseInt(a),e[a])},e=>{console.error("Error asking to translate chat:",e)})}async translateTextBasedOnParser(e,a){if(this.customLanguage)return;let t=this.parser.extract(e),s=e,n=[];for(let e of t){let t={originalStr:e.text,bounds:e.bounds,translatedStr:await this.translator.translateSentence(e.text,a)};n.push(t)}n.sort((e,a)=>a.bounds.start-e.bounds.start);for(let e of n){let a=e.bounds.start,t=e.bounds.end;s=s.slice(0,a)+e.translatedStr+s.slice(t)}return{messageData:n,translatedMessage:s}}clearEverything(){this.extracted_text={},this.originalMessages={}}async translateMessageAndUpdate(e){let a=this.manipulator.getMessageData(e).mes,t=this.characterManager.getCharacterLanguageData(this.manipulator.getMessageData(e).name);this.translateTextBasedOnParser(a,t).then(a=>{this.extracted_text[e]=a.messageData,this.manipulator.updateMessage(e,a.translatedMessage)})}updateCharacterLanguage(e,a){this.characterManager.setCharacterLanguageData(e,a)}returnCharacterLanguage(e){return this.characterManager.getCharacterLanguageData(e)}};g.on(o.GENERATE_AFTER_DATA,(e,a)=>{let t=l.chatCompletionSettings.new_chat_prompt,s=0;if(c){console.log("Generation started!!");for(let a=0;a<e.prompt.length;a++){let n=a-s;e.prompt[a].content==t&&(s=a+1),null!==s&&d.extracted_text[n]&&(e.prompt[a].content=d.originalMessages[n])}}}),g.on(o.MESSAGE_SENT,()=>{c=!0}),g.on(o.CHAT_CREATED,()=>{d.extracted_text={},d.originalMessages={},d.translateChat()}),g.on(o.CHAT_CHANGED,()=>{!async function(){const e=document.getElementById("cipher-extension-drawer");e&&e.remove();let a=$("#avatar-and-name-block"),t=SillyTavern.getContext().characterId;if(void 0===t)return;let s=SillyTavern.getContext().characters[t].name,n=document.createElement("div");n.id="cipher-extension-drawer",n.classList.add("inline-drawer"),n.style.marginTop="5px",n.style.borderTop="1px solid #444",n.style.paddingTop="5px";let i=document.createElement("select");i.id="character-language-select",i.classList.add("text_pole"),i.style.width="60%",i.style.marginRight="5px";for(let e in r){let a=document.createElement("option");a.value=r[e],a.textContent=e,i.append(a)}let l=document.createElement("label");l.classList.add("checkbox_label"),l.innerHTML="Cipher: ";let o=document.createElement("input");o.type="checkbox",o.checked=!d.isDisabled,o.addEventListener("change",()=>{d.setDisabled(!o.checked)}),l.append(o),n.append(i),n.append(l),a.after(n);let g=d.returnCharacterLanguage(s);for(let e in r)r[e]==g&&(i.value=r[e]);d.updateCharacterLanguage(s,g||i.value),i.addEventListener("change",()=>{d.updateCharacterLanguage(s,i.value),d.revertAllMessages(),d.extracted_text={},d.translateChat()}),console.log("Mounted options!")}(),d.translateChat()}),g.on(o.MESSAGE_RECEIVED,()=>{d.translateMessageAndUpdate(SillyTavern.getContext().chat.length-1),c=!1}),jQuery(async()=>{SillyTavern.getContext().renderExtensionTemplateAsync("translation-and-ciphers","settings"),async function(){let e=SillyTavern.getContext().extensionSettings;0===Object.keys(e[u]).length&&(e[u]=h)}()});